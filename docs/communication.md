# Server-Client communication over TCP

## Communication

The server and Client communicate through TCP protocol library, that is similar to WebSockets (two-way communication).
The server and Telegram API (Bot) communicate through channels.

### Server-client messages

#### Payload struct

The messages sent to and from the server are in **JSON** format, encoded with **base64** encoding. The JSON object sent
to and from the client is the `Payload` struct.

The `Payload.Id` field is a UUID, generated by the server when a command is issued. It maps the `Payload` to
the `ChatId` when the client responds and the server interprets the response. The `Payload.Data` contains the data
produced by server and client plugins. The `Payload.Command` is used to execute the plugin on the client. Both
the `Payload.Success` and `Payload.Error` are used for error handling in both client and server.

```golang
package shared

type Payload struct {
	Id             string
	ServiceNodeKey string
	Data           interface{}
	Command        string
	Success        bool
	Error          string
}
```

### Telegram Bot and TCP server communication

The communication Server-Telegram Bot occurs on channels through dedicated listeners, that run in a goroutine. The
message that comes from the Telegram Bot is parsed and sent through the channel as a `Command` struct. The message that
comes as a reply from the server is a `Reply` struct.

#### Command struct

The `Command` struct is created from a Telegram Message, which is a string. The message is split by spaces; the first
element is a `Command.Name`, while the other elements of the array represent the `Command.Args` (arguments). The
arguments are passed to the plugin which handles the `Command`. The `ChatId` is used to map the response to the chat.

```golang
package bot

type Command struct {
	Name   string
	Args   []string
	ChatId int64
}
```

#### Reply struct

The `Reply` struct is used in communication from the server to the Telegram Bot. The `ChatId` is used to reply to a
specific chat when. The `ReplyType` represents one of the constants and specifies the type of `Content`. The `Content`
is a generic representation of the data, usually produced by the plugin (e.g. an Image, Text, Audio file, etc.)

```golang
package bot

type Reply struct {
	ChatId    int64
	ReplyType string
	Content   interface{}
}
```





